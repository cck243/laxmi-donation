<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jay Maa Laxmi Temple Donation System</title>
  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- jsPDF & html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <!-- Hidden receipt template -->
  <div id="receipt-template" style="padding:20px; width:400px; font-family:monospace; background:white; display:none;">
    <p>🪔 Jay Maa Laxmi Temple</p>
    <p>New Building, Mantapur & Kaisira</p>
    <p>Dist - Bhadrak - 756122</p>
    <p>━━━━━━━━━━━━━━━━</p>
    <p><strong>Receipt:</strong> <span id="rt-receipt"></span></p>
    <p><strong>Name:</strong> <span id="rt-name"></span></p>
    <p><strong>Vehicle:</strong> <span id="rt-vehicle"></span></p>
    <p><strong>Amount:</strong> ₹<span id="rt-amount"></span></p>
    <p><strong>Date:</strong> <span id="rt-date"></span></p>
    <p>━━━━━━━━━━━━━━━━</p>
    <p>Thank you for your donation!</p>
    <p>May Goddess Laxmi bless you 🙏</p>
  </div>

  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;
    const { jsPDF } = window.jspdf;

    // --- Icons (minimal for clarity) ---
    const User = (props) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}>
        <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" />
        <circle cx="12" cy="7" r="4" />
      </svg>
    );
    const Car = (props) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}>
        <path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2" />
        <circle cx="7" cy="17" r="2" />
        <path d="M9 17h6" />
        <circle cx="17" cy="17" r="2" />
      </svg>
    );
    const IndianRupee = (props) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}>
        <path d="M6 3h12" />
        <path d="M6 8h12" />
        <path d="m6 13 8.5 8" />
        <path d="M6 13h3" />
        <path d="M9 13c6.667 0 6.667-10 0-10" />
      </svg>
    );

    function TempleDonationApp() {
      const [formData, setFormData] = useState({ donorName: '', vehicleNumber: '', amount: '' });
      const [donations, setDonations] = useState([]);
      const [currentReceipt, setCurrentReceipt] = useState(null);
      const [isDuplicate, setIsDuplicate] = useState(false);

      // Get today's donations
      const today = new Date().toISOString().split('T')[0];
      const todayDonations = useMemo(() => 
        donations.filter(d => d.isoDate === today), [donations]
      );

      // Check for duplicate on every input change
      useEffect(() => {
        const { donorName, vehicleNumber } = formData;
        if (!donorName && !vehicleNumber) {
          setIsDuplicate(false);
          return;
        }
        const exists = todayDonations.some(d =>
          d.donorName.toLowerCase() === donorName.toLowerCase() &&
          d.vehicleNumber.toLowerCase() === vehicleNumber.toLowerCase()
        );
        setIsDuplicate(exists);
      }, [formData, todayDonations]);

      const handleSubmit = () => {
        const { donorName, amount } = formData;
        if (!donorName || !amount) {
          alert('Donor Name and Amount are required.');
          return;
        }
        if (isDuplicate) {
          alert('Duplicate entry detected for today. Please verify.');
          return;
        }

        const now = new Date();
        const newDonation = {
          ...formData,
          receiptNumber: `JMLT${Date.now().toString().slice(-8)}`,
          date: now.toLocaleDateString('en-IN'),
          isoDate: today,
          time: now.toLocaleTimeString('en-IN')
        };

        setDonations([newDonation, ...donations]);
        setCurrentReceipt(newDonation);
        setFormData({ donorName: '', vehicleNumber: '', amount: '' });
        setIsDuplicate(false);

        // Auto-hide receipt after 6 sec
        setTimeout(() => setCurrentReceipt(null), 6000);
      };

      // --- PDF Download (FIXED) ---
      const downloadReceiptPDF = async () => {
        if (!currentReceipt) return;

        const template = document.getElementById('receipt-template');
        document.getElementById('rt-receipt').textContent = currentReceipt.receiptNumber;
        document.getElementById('rt-name').textContent = currentReceipt.donorName;
        document.getElementById('rt-vehicle').textContent = currentReceipt.vehicleNumber || '—';
        document.getElementById('rt-amount').textContent = currentReceipt.amount;
        document.getElementById('rt-date').textContent = currentReceipt.date;

        try {
          const canvas = await html2canvas(template, { scale: 2 });
          const imgData = canvas.toDataURL('image/png');
          const pdf = new jsPDF('p', 'mm', 'a5');
          const width = pdf.internal.pageSize.getWidth();
          const height = (canvas.height * width) / canvas.width;
          pdf.addImage(imgData, 'PNG', 0, 0, width, Math.min(height, 297));
          pdf.save(`JMLT_Receipt_${currentReceipt.receiptNumber}.pdf`);
        } catch (err) {
          console.error('PDF generation failed:', err);
          alert('Failed to generate PDF. Please try again.');
        }
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-orange-50 via-yellow-50 to-red-50 p-4">
          <div className="max-w-4xl mx-auto">
            <div className="bg-gradient-to-r from-orange-600 to-red-600 rounded-lg shadow-xl p-6 mb-6 text-white text-center">
              <h1 className="text-2xl font-bold">🪔 Jay Maa Laxmi Temple</h1>
              <p className="text-sm">New Building, Mantapur & Kaisira, Dist - Bhadrak - 756122</p>
            </div>

            <div className="bg-white rounded-lg shadow p-6 mb-6">
              <h2 className="text-xl font-bold text-orange-700 mb-4">Donation Entry</h2>

              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    <User className="inline mr-1" /> Donor Name *
                  </label>
                  <input
                    type="text"
                    value={formData.donorName}
                    onChange={e => setFormData({...formData, donorName: e.target.value})}
                    className={`w-full px-3 py-2 border rounded focus:ring-2 focus:ring-orange-500 ${
                      isDuplicate ? 'border-red-500 bg-red-50' : ''
                    }`}
                    placeholder="Enter name"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    <Car className="inline mr-1" /> Vehicle Number (Optional)
                  </label>
                  <input
                    type="text"
                    value={formData.vehicleNumber}
                    onChange={e => setFormData({...formData, vehicleNumber: e.target.value.toUpperCase()})}
                    className={`w-full px-3 py-2 border rounded focus:ring-2 focus:ring-orange-500 ${
                      isDuplicate ? 'border-red-500 bg-red-50' : ''
                    }`}
                    placeholder="e.g. OD01AB1234"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    <IndianRupee className="inline mr-1" /> Amount (₹) *
                  </label>
                  <input
                    type="number"
                    value={formData.amount}
                    onChange={e => setFormData({...formData, amount: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-orange-500"
                    min="1"
                    placeholder="Enter amount"
                  />
                </div>

                {isDuplicate && (
                  <div className="p-2 bg-red-100 border border-red-300 rounded text-red-700 text-sm">
                    ⚠️ This donor and vehicle already donated today.
                  </div>
                )}

                <button
                  onClick={handleSubmit}
                  disabled={isDuplicate}
                  className={`w-full py-2 rounded font-semibold ${
                    isDuplicate
                      ? 'bg-gray-400 cursor-not-allowed'
                      : 'bg-gradient-to-r from-orange-600 to-red-600 text-white hover:from-orange-700 hover:to-red-700'
                  }`}
                >
                  Submit Donation
                </button>
              </div>
            </div>

            {/* Success Receipt */}
            {currentReceipt && (
              <div className="bg-green-50 border border-green-500 rounded-lg p-4 mb-6 animate-pulse">
                <p className="font-bold text-green-700">✅ Receipt Generated!</p>
                <p><strong>{currentReceipt.donorName}</strong> donated ₹{currentReceipt.amount}</p>
                <p className="text-sm">Receipt: {currentReceipt.receiptNumber} • {currentReceipt.date}</p>
                <button
                  onClick={downloadReceiptPDF}
                  className="mt-2 text-sm bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700"
                >
                  Download PDF Receipt
                </button>
              </div>
            )}

            {/* Today's Donations */}
            <div className="bg-white rounded-lg shadow p-4">
              <h3 className="font-bold text-lg mb-3">Today’s Donations ({todayDonations.length})</h3>
              <div className="space-y-2 max-h-60 overflow-y-auto">
                {todayDonations.length === 0 ? (
                  <p className="text-gray-500">No donations yet.</p>
                ) : (
                  todayDonations.map((d, i) => (
                    <div key={i} className="border-l-4 border-orange-500 pl-3 py-1">
                      <p className="font-medium">{d.donorName}</p>
                      {d.vehicleNumber && <p className="text-sm text-gray-600">{d.vehicleNumber}</p>}
                      <p className="text-sm text-gray-500">₹{d.amount} • {d.receiptNumber}</p>
                    </div>
                  ))
                )}
              </div>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<TempleDonationApp />);
  </script>
</body>
</html>
